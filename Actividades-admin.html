<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Actividades - GAD Atacames</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0097e6;
            --success: #44bd32;
            --danger: #e84118;
            --warning: #fbc531;
            --dark: #2f3640;
            --bg: #f5f6fa;
        }

        body { font-family: 'Poppins', sans-serif; background: var(--bg); padding: 40px 20px; }
        .container { max-width: 1000px; margin: auto; }
        
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 30px; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: span 2; }
        
        input, select, textarea {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-top: 5px; box-sizing: border-box;
        }

        .url-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .btn {
            padding: 12px 25px; border: none; border-radius: 8px; color: white;
            font-weight: 600; cursor: pointer; transition: 0.3s;
            display: inline-flex; align-items: center; gap: 8px;
        }
        
        .btn-add-url { background: var(--dark); font-size: 0.8rem; margin-top: 10px; }
        .btn-save { background: var(--success); width: 100%; margin-top: 20px; justify-content: center; }
        .btn-update { background: var(--warning); color: #2f3640; width: 100%; margin-top: 20px; justify-content: center; }
        .btn-delete { background: var(--danger); padding: 8px 12px; }
        .btn-edit { background: var(--primary); padding: 8px 12px; margin-right: 5px; }
        .btn-cancel { background: #95a5a6; width: 100%; margin-top: 10px; justify-content: center; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: var(--dark); color: white; }

        .badge { padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; text-transform: capitalize; }
        .badge-sesion { background: #d1ecf1; color: #0c5460; }
        .badge-territorio { background: #d4edda; color: #155724; }
        .badge-social { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2 id="form-title"><i class="fa-solid fa-calendar-plus"></i> Gestionar Nueva Actividad</h2>
        <form id="actividadForm">
            <input type="hidden" id="actividadId">

            <div class="form-grid">
                <div class="full-width">
                    <label>T√≠tulo de la Actividad</label>
                    <input type="text" id="titulo" placeholder="Ej: Sesi√≥n Ordinaria de Directorio" required>
                </div>
                <div>
                    <label>Categor√≠a</label>
                    <select id="categoria">
                        <option value="sesion">Sesi√≥n</option>
                        <option value="territorio">Territorio</option>
                        <option value="social">Social</option>
                    </select>
                </div>
                <div>
                    <label>Fecha</label>
                    <input type="date" id="fecha" required>
                </div>
                <div>
                    <label>Hora</label>
                    <input type="time" id="hora">
                </div>
                <div>
                    <label>Lugar</label>
                    <input type="text" id="lugar" placeholder="Ej: Sal√≥n Auditorio">
                </div>
                <div class="full-width">
                    <label>Descripci√≥n</label>
                    <textarea id="descripcion" rows="3" placeholder="Detalles de la actividad..."></textarea>
                </div>
                
                <div class="full-width">
                    <label><i class="fa-solid fa-link"></i> Enlaces de Fotos (M√°ximo 20)</label>
                    <div id="urlContainer">
                        <div class="url-input-group">
                            <input type="url" class="foto-url-input" placeholder="https://imagen-ejemplo.com/foto1.jpg">
                        </div>
                    </div>
                    <button type="button" class="btn btn-add-url" onclick="agregarCampoUrl()">
                        <i class="fa-solid fa-plus"></i> A√±adir otra URL
                    </button>
                </div>
            </div>
            
            <button type="submit" id="btn-submit" class="btn btn-save">
                <i class="fa-solid fa-floppy-disk"></i> <span id="btn-text">Guardar Actividad</span>
            </button>
            <button type="button" id="btn-cancel" class="btn btn-cancel" style="display: none;" onclick="cancelarEdicion()">
                Cancelar Edici√≥n
            </button>
        </form>
    </div>

    <div class="card">
        <h3>Actividades Registradas</h3>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>T√≠tulo</th>
                        <th>Categor√≠a</th>
                        <th>Fotos</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaActividades"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const API_URL = "https://backend-asamblea-atacames.onrender.com/api/actividades";
    let listaActividadesCache = []; // Para buscar datos al editar sin llamar a la API

    function agregarCampoUrl(valor = "") {
        const container = document.getElementById('urlContainer');
        const inputs = container.getElementsByClassName('foto-url-input');
        
        if (inputs.length < 20) {
            const div = document.createElement('div');
            div.className = 'url-input-group';
            div.innerHTML = `
                <input type="url" class="foto-url-input" value="${valor}" placeholder="https://imagen-ejemplo.com/foto${inputs.length + 1}.jpg">
                <button type="button" onclick="this.parentElement.remove()" style="background:none; border:none; color:red; cursor:pointer">
                    <i class="fa-solid fa-circle-xmark"></i>
                </button>
            `;
            container.appendChild(div);
        }
    }

    // CARGAR TABLA (GET)
    async function cargarActividades() {
        try {
            const res = await fetch(API_URL);
            listaActividadesCache = await res.json();
            const tabla = document.getElementById('tablaActividades');
            
            tabla.innerHTML = listaActividadesCache.map(act => `
                <tr>
                    <td>${new Date(act.fecha).toLocaleDateString()}</td>
                    <td><strong>${act.titulo}</strong></td>
                    <td><span class="badge badge-${act.categoria}">${act.categoria}</span></td>
                    <td><i class="fa-solid fa-images"></i> ${act.imagenes ? act.imagenes.length : 0}</td>
                    <td>
                        <button onclick="prepararEdicion('${act._id}')" class="btn btn-edit">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                        <button onclick="eliminarActividad('${act._id}')" class="btn btn-delete">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } catch (e) {
            console.error("Error al cargar actividades:", e);
        }
    }

    // PREPARAR FORMULARIO PARA EDITAR
    function prepararEdicion(id) {
        const act = listaActividadesCache.find(a => a._id === id);
        if(!act) return;

        // Llenar campos simples
        document.getElementById('actividadId').value = act._id;
        document.getElementById('titulo').value = act.titulo;
        document.getElementById('categoria').value = act.categoria;
        document.getElementById('fecha').value = act.fecha.split('T')[0]; // Formato YYYY-MM-DD
        document.getElementById('hora').value = act.hora || "";
        document.getElementById('lugar').value = act.lugar || "";
        document.getElementById('descripcion').value = act.descripcion || "";

        // Llenar URLs
        const container = document.getElementById('urlContainer');
        container.innerHTML = ""; // Limpiar
        if (act.imagenes && act.imagenes.length > 0) {
            act.imagenes.forEach(url => agregarCampoUrl(url));
        } else {
            agregarCampoUrl();
        }

        // Cambiar interfaz
        document.getElementById('form-title').innerHTML = '<i class="fa-solid fa-pen-to-square"></i> Editando Actividad';
        document.getElementById('btn-text').innerText = "Actualizar Cambios";
        document.getElementById('btn-submit').className = "btn btn-update";
        document.getElementById('btn-cancel').style.display = "inline-flex";
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function cancelarEdicion() {
        document.getElementById('actividadForm').reset();
        document.getElementById('actividadId').value = "";
        document.getElementById('urlContainer').innerHTML = '<div class="url-input-group"><input type="url" class="foto-url-input" placeholder="https://..."></div>';
        
        document.getElementById('form-title').innerHTML = '<i class="fa-solid fa-calendar-plus"></i> Gestionar Nueva Actividad';
        document.getElementById('btn-text').innerText = "Guardar Actividad";
        document.getElementById('btn-submit').className = "btn btn-save";
        document.getElementById('btn-cancel').style.display = "none";
    }

    // GUARDAR O ACTUALIZAR
    document.getElementById('actividadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('actividadId').value;
        
        const inputsUrl = document.querySelectorAll('.foto-url-input');
        const listaUrls = Array.from(inputsUrl).map(input => input.value.trim()).filter(val => val !== "");

        const datos = {
            titulo: document.getElementById('titulo').value,
            categoria: document.getElementById('categoria').value,
            fecha: document.getElementById('fecha').value,
            hora: document.getElementById('hora').value,
            lugar: document.getElementById('lugar').value,
            descripcion: document.getElementById('descripcion').value,
            imagenes: listaUrls
        };

        const metodo = id ? 'PUT' : 'POST';
        const url = id ? `${API_URL}/${id}` : API_URL;

        try {
            const res = await fetch(url, {
                method: metodo,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datos)
            });
            
            if(res.ok) {
                alert(id ? "‚úÖ Actividad actualizada" : "‚úÖ Actividad guardada");
                cancelarEdicion();
                cargarActividades();
            } else {
                alert("‚ùå Error al procesar la solicitud");
            }
        } catch (err) {
            alert("‚ùå Error de conexi√≥n");
        }
    });

    // ELIMINAR
    async function eliminarActividad(id) {
        if (!confirm("¬øEliminar actividad definitivamente?")) return;
        try {
            const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
            if (res.ok) {
                alert("üóëÔ∏è Eliminada");
                cargarActividades();
            }
        } catch (error) {
            alert("Error al eliminar");
        }
    }

    cargarActividades();
</script>

</body>
</html>
