<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Consejos Rurales | Asamblea Atacames</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
   :root{
      --primary:#0d6efd;
      --dark:#0f172a;
      --bg:#f6f8fb;
      --card:#ffffff;
      --muted:#64748b;
      --shadow: 0 12px 30px rgba(15, 23, 42, .08);
      --radius: 18px;
    }

    body{
      font-family:'Poppins',sans-serif;
      background:var(--bg);
      color:#111827;
      padding-top:90px;
    }

    .navbar{
      background: rgba(255,255,255,.97);
      box-shadow: 0 2px 16px rgba(0,0,0,.08);
      backdrop-filter: blur(10px);
      padding: 14px 0; /* ✅ antes 10px */
    }

    /* ✅ LOGO MÁS GRANDE (RESPONSIVO) */
    .brand-logo{
      height: 110px;        /* ✅ antes 72px */
      max-height: 120px;
      width: auto;
      object-fit: contain;
    }
    @media (max-width: 576px){
      .brand-logo{ height: 90px; }
    }

    .page-header{
      background:
        linear-gradient(135deg, rgba(13,110,253,.92), rgba(15,23,42,.92)),
        url('https://images.unsplash.com/photo-1517486808906-6ca8b3f04846?auto=format&fit=crop&w=1600&q=80');
      background-size: cover;
      background-position: center;
      color: #fff;
      padding: 80px 0 70px;
      clip-path: ellipse(150% 100% at 50% 0%);
    }

    .header-chip{
      display:inline-flex;
      align-items:center;
      gap:10px;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.18);
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 600;
      margin-top: 14px;
    }

    .main-card{
      background:var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-top: -42px;
      padding: 22px;
      margin-bottom: 40px;
    }

    .btn-pill{ border-radius: 999px; padding: 10px 18px; font-weight: 700; }
    .btn-soft{
      background: rgba(13,110,253,.12);
      border: 1px solid rgba(13,110,253,.18);
      color: #0b5ed7;
    }

    .badge-status{
      padding: 6px 12px;
      border-radius: 999px;
      font-weight: 800;
      font-size: .72rem;
      letter-spacing: .3px;
      display: inline-block;
    }
    .st-ACTIVO{ background:#dbeafe; color:#1d4ed8; }
    .st-INACTIVO{ background:#ffe4e6; color:#be123c; }
    .st-EN_PROCESO{ background:#fef3c7; color:#b45309; }

    .table thead th{ font-size:.88rem; font-weight:800; color:#0f172a; }
    .muted{ color: var(--muted); }

    .skeleton{
      background:linear-gradient(90deg,#f0f2f5 25%,#e8ebf0 37%,#f0f2f5 63%);
      background-size:400% 100%;
      animation: shine 1.2s ease-in-out infinite;
      border-radius: 12px;
      height: 14px;
    }
    @keyframes shine{
      0%{ background-position:100% 0 }
      100%{ background-position:0 0 }
    }

    .form-section-title{
      font-weight: 800;
      color:#0b5ed7;
      margin-top: 10px;
      margin-bottom: 6px;
    }

    footer{
      background: var(--dark);
      color: #fff;
      padding: 36px 0;
      margin-top: 50px;
    }

    .small-help{ font-size: .85rem; color: var(--muted); }
  </style>
</head>

<body>

  <!-- NAV -->
  <nav class="navbar navbar-expand-lg fixed-top">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-3" href="Index.html">
        <img class="brand-logo"
             src="https://fidelpperez2021.github.io/Almacenamiento.io/Captura%20de%20pantalla%202026-01-03%20132017.png"
             alt="Asamblea Cantonal de Atacames" />
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
          <li class="nav-item"><a class="nav-link fw-bold" href="Index.html">Inicio</a></li>

          <!-- Ajusta estos enlaces si ya tienes páginas públicas -->
          <li class="nav-item">
            <a class="nav-link fw-bold" href="https://fidelpperez2021.github.io/Almacenamiento.io/Consejos%20rurales.html">
              <i class="fa-solid fa-eye me-2"></i>Consulta pública (Rurales)
            </a>
          </li>

          <li class="nav-item">
            <span class="nav-link fw-bold text-primary">
              <i class="fa-solid fa-shield-halved me-2"></i>Admin
            </span>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- HEADER -->
  <header class="page-header">
    <div class="container animate__animated animate__fadeIn">
      <h1 class="fw-bold display-5 mb-1">Administrador</h1>
      <p class="lead m-0">Consejos Rurales (CRUD completo)</p>
      <div class="header-chip">
        <i class="fa-solid fa-database"></i>
        <span>API: <span id="apiStatus">Conectando...</span></span>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="main-card animate__animated animate__fadeInUp">

      <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-3">
        <div>
          <h4 class="fw-bold m-0">
            <i class="fa-solid fa-mountain-sun me-2 text-primary"></i>Directorio Rural (Admin)
          </h4>
          <small class="muted">Crea, edita y elimina consejos rurales. Los usuarios solo visualizan.</small>
        </div>

        <div class="d-flex gap-2 flex-wrap">
          <button class="btn btn-soft btn-pill" onclick="obtenerConsejos(true)">
            <i class="fa-solid fa-rotate me-2"></i>Actualizar
          </button>
          <button class="btn btn-primary btn-pill" onclick="abrirCrear()">
            <i class="fa-solid fa-plus me-2"></i>Nuevo Consejo
          </button>
        </div>
      </div>

      <!-- FILTROS -->
      <div class="row g-2 align-items-end mb-3">
        <div class="col-md-6">
          <label class="form-label fw-bold">Buscar</label>
          <div class="input-group">
            <span class="input-group-text bg-white"><i class="fa-solid fa-magnifying-glass"></i></span>
            <input id="q" type="text" class="form-control" placeholder="Código, nombre, comunidad o presidente..." />
          </div>
        </div>

        <div class="col-md-3">
          <label class="form-label fw-bold">Parroquia</label>
          <select id="fParroquia" class="form-select">
            <option value="">Todas</option>
            <option value="Atacames">Atacames</option>
            <option value="Súa">Súa</option>
            <option value="Tonsupa">Tonsupa</option>
            <option value="Tonchigüe">Tonchigüe</option>
            <option value="La Unión">La Unión</option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label fw-bold">Estado</label>
          <select id="fEstado" class="form-select">
            <option value="">Todos</option>
            <option value="ACTIVO">ACTIVO</option>
            <option value="EN_PROCESO">EN_PROCESO</option>
            <option value="INACTIVO">INACTIVO</option>
          </select>
        </div>
      </div>

      <!-- TABLA -->
      <div class="table-responsive">
        <table class="table align-middle">
          <thead class="table-light">
            <tr>
              <th>Código</th>
              <th>Consejo</th>
              <th>Comunidad</th>
              <th>Presidente</th>
              <th>Contacto</th>
              <th>Estado</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody id="listaConsejos"></tbody>
        </table>
      </div>

      <div id="emptyState" class="text-center py-4 d-none">
        <i class="fa-regular fa-folder-open fa-2x mb-2"></i>
        <div class="fw-bold">No hay registros para mostrar</div>
        <small class="muted">Crea un nuevo consejo o ajusta los filtros.</small>
      </div>
    </div>
  </main>

  <!-- MODAL FORM (CREATE/EDIT) -->
  <div class="modal fade" id="modalForm" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content rounded-4 shadow border-0">
        <div class="modal-header bg-primary text-white p-4">
          <h5 class="modal-title fw-bold" id="formTitle">
            <i class="fa-solid fa-file-signature me-2"></i>Formulario
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body p-4">
          <form id="formConsejo" class="row g-3">

            <div class="col-md-4">
              <label class="form-label fw-bold">Código *</label>
              <input type="text" class="form-control" name="codigo" placeholder="CR-ATC-001" required />
              <div class="small-help mt-1">Debe ser único.</div>
            </div>

            <div class="col-md-8">
              <label class="form-label fw-bold">Nombre del Consejo *</label>
              <input type="text" class="form-control" name="nombre" placeholder="Ej: Consejo Rural X" required />
            </div>

            <div class="col-md-4">
              <label class="form-label fw-bold">Parroquia</label>
              <select class="form-select" name="parroquia">
                <option value="">(Opcional)</option>
                <option value="Atacames">Atacames</option>
                <option value="Súa">Súa</option>
                <option value="Tonsupa">Tonsupa</option>
                <option value="Tonchigüe">Tonchigüe</option>
                <option value="La Unión">La Unión</option>
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label fw-bold">Comunidad</label>
              <input type="text" class="form-control" name="comunidad" placeholder="Ej: Comunidad X" />
            </div>

            <div class="col-md-4">
              <label class="form-label fw-bold">Estado *</label>
              <select class="form-select" name="estado" required>
                <option value="ACTIVO">ACTIVO</option>
                <option value="EN_PROCESO">EN_PROCESO</option>
                <option value="INACTIVO">INACTIVO</option>
              </select>
            </div>

            <div class="col-12">
              <div class="form-section-title"><i class="fa-solid fa-location-dot me-2"></i>Ubicación (Geo)</div>
              <div class="small-help">Se guarda como GeoJSON Point [longitud, latitud].</div>
            </div>

            <div class="col-md-6">
              <label class="form-label fw-bold">Longitud (lng)</label>
              <input type="number" step="any" class="form-control" name="lng" placeholder="-79.84" />
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">Latitud (lat)</label>
              <input type="number" step="any" class="form-control" name="lat" placeholder="0.87" />
            </div>

            <div class="col-12">
              <hr class="my-2">
              <div class="form-section-title"><i class="fa-solid fa-users me-2"></i>Directiva</div>
            </div>

            <div class="col-md-6">
              <label class="form-label fw-bold">Presidente (Nombres)</label>
              <input type="text" class="form-control" name="pres_nombres" />
            </div>
            <div class="col-md-3">
              <label class="form-label fw-bold">Teléfono</label>
              <input type="text" class="form-control" name="pres_telefono" />
            </div>
            <div class="col-md-3">
              <label class="form-label fw-bold">Email</label>
              <input type="email" class="form-control" name="pres_email" placeholder="correo@..." />
            </div>

            <div class="col-12 d-flex justify-content-end gap-2 mt-2">
              <button type="button" class="btn btn-light btn-pill" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary btn-pill" id="btnGuardar">
                <i class="fa-solid fa-floppy-disk me-2"></i>Guardar
              </button>
            </div>

          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL DETALLE -->
  <div class="modal fade" id="modalDetalle" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content rounded-4 shadow border-0">
        <div class="modal-header bg-dark text-white p-4">
          <h5 class="modal-title fw-bold">
            <i class="fa-solid fa-circle-info me-2"></i>Detalle del Consejo Rural
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-4" id="detalleBody"></div>
      </div>
    </div>
  </div>

  <footer class="text-center">
    <div class="container">
      <p class="m-0">&copy; 2026 Asamblea Cantonal de Atacames.</p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ✅ Backend en Render
    const API_URL = "https://backend-asamblea-atacames.onrender.com/api/consejos-rurales";

    let cacheConsejos = [];
    let modo = "create"; // create | edit
    let editId = null;

    document.addEventListener("DOMContentLoaded", () => {
      wireFilters();
      obtenerConsejos();
    });

    function wireFilters() {
      document.getElementById("q").addEventListener("input", debounce(aplicarFiltros, 250));
      document.getElementById("fParroquia").addEventListener("change", aplicarFiltros);
      document.getElementById("fEstado").addEventListener("change", aplicarFiltros);
    }

    async function pingApi() {
      try {
        const r = await fetch(API_URL, { method: "GET" });
        document.getElementById("apiStatus").textContent = r.ok ? "Online" : "Error";
      } catch {
        document.getElementById("apiStatus").textContent = "Offline";
      }
    }

    async function obtenerConsejos(showToast = false) {
      await pingApi();
      renderLoading();

      try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error("No se pudo obtener datos");
        const datos = await res.json();
        cacheConsejos = Array.isArray(datos) ? datos : (datos.data || []);
        aplicarFiltros();

        if (showToast) Swal.fire({ icon: "success", title: "Actualizado", timer: 900, showConfirmButton: false });
      } catch (err) {
        console.error(err);
        renderEmpty(true);
        Swal.fire("Error", "No se pudo cargar el directorio.", "error");
      }
    }

    function aplicarFiltros() {
      const q = (document.getElementById("q").value || "").toLowerCase().trim();
      const parroquia = document.getElementById("fParroquia").value;
      const estado = document.getElementById("fEstado").value;

      let list = [...cacheConsejos];

      if (parroquia) list = list.filter(x => (x.parroquia || "") === parroquia);
      if (estado) list = list.filter(x => (x.estado || "") === estado);

      if (q) {
        list = list.filter(x => {
          const pres = x?.directiva?.presidente?.nombres || "";
          return (
            (x.codigo || "").toLowerCase().includes(q) ||
            (x.nombre || "").toLowerCase().includes(q) ||
            (x.comunidad || "").toLowerCase().includes(q) ||
            pres.toLowerCase().includes(q)
          );
        });
      }

      renderTable(list);
    }

    function badgeEstado(estado) {
      const st = estado || "ACTIVO";
      return `<span class="badge-status st-${st}">${st}</span>`;
    }

    function renderLoading() {
      const tbody = document.getElementById("listaConsejos");
      document.getElementById("emptyState").classList.add("d-none");
      tbody.innerHTML = `
        <tr><td colspan="7">
          <div class="p-3">
            <div class="skeleton mb-2" style="width:45%"></div>
            <div class="skeleton mb-2" style="width:70%"></div>
            <div class="skeleton" style="width:55%"></div>
          </div>
        </td></tr>
      `;
    }

    function renderEmpty(show = false) {
      document.getElementById("listaConsejos").innerHTML = "";
      document.getElementById("emptyState").classList.toggle("d-none", !show);
    }

    function renderTable(list) {
      const tbody = document.getElementById("listaConsejos");
      tbody.innerHTML = "";

      if (!list.length) {
        renderEmpty(true);
        return;
      }
      renderEmpty(false);

      list.forEach(c => {
        const pres = c?.directiva?.presidente?.nombres || "No asignado";
        const tel = c?.directiva?.presidente?.telefono || "-";

        tbody.innerHTML += `
          <tr>
            <td><span class="badge bg-light text-dark border">${escapeHtml(c.codigo || "-")}</span></td>
            <td>
              <div class="fw-bold">${escapeHtml(c.nombre || "-")}</div>
              <small class="muted">${escapeHtml(c.parroquia || "-")}</small>
            </td>
            <td>${escapeHtml(c.comunidad || "-")}</td>
            <td>${escapeHtml(pres)}</td>
            <td><i class="fa-solid fa-phone me-1 text-success"></i>${escapeHtml(tel)}</td>
            <td>${badgeEstado(c.estado)}</td>
            <td class="text-center">
              <button class="btn btn-sm btn-outline-dark border-0" onclick="verDetalle('${c._id}')" title="Ver detalle">
                <i class="fa-regular fa-eye"></i>
              </button>
              <button class="btn btn-sm btn-outline-primary border-0" onclick="abrirEditar('${c._id}')" title="Editar">
                <i class="fa-regular fa-pen-to-square"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger border-0" onclick="eliminarConsejo('${c._id}')" title="Eliminar">
                <i class="fa-regular fa-trash-can"></i>
              </button>
            </td>
          </tr>
        `;
      });
    }

    function abrirCrear() {
      modo = "create";
      editId = null;
      document.getElementById("formTitle").innerHTML = `<i class="fa-solid fa-plus me-2"></i>Nuevo Consejo Rural`;
      document.getElementById("btnGuardar").innerHTML = `<i class="fa-solid fa-floppy-disk me-2"></i>Guardar`;
      document.getElementById("formConsejo").reset();

      new bootstrap.Modal(document.getElementById("modalForm")).show();
    }

    function abrirEditar(id) {
      const c = cacheConsejos.find(x => x._id === id);
      if (!c) return;

      modo = "edit";
      editId = id;

      document.getElementById("formTitle").innerHTML = `<i class="fa-solid fa-pen-to-square me-2"></i>Editar Consejo Rural`;
      document.getElementById("btnGuardar").innerHTML = `<i class="fa-solid fa-floppy-disk me-2"></i>Guardar cambios`;

      const f = document.getElementById("formConsejo");
      f.codigo.value = c.codigo || "";
      f.nombre.value = c.nombre || "";
      f.parroquia.value = c.parroquia || "";
      f.comunidad.value = c.comunidad || "";
      f.estado.value = c.estado || "ACTIVO";

      const coords = c?.ubicacion?.coordinates || [];
      f.lng.value = coords[0] ?? "";
      f.lat.value = coords[1] ?? "";

      const pres = c?.directiva?.presidente || {};
      f.pres_nombres.value = pres.nombres || "";
      f.pres_telefono.value = pres.telefono || "";
      f.pres_email.value = pres.email || "";

      new bootstrap.Modal(document.getElementById("modalForm")).show();
    }

    document.getElementById("formConsejo").addEventListener("submit", async (e) => {
      e.preventDefault();

      const f = e.target;

      const lng = parseFloat(f.lng.value);
      const lat = parseFloat(f.lat.value);
      const coordsOK = Number.isFinite(lng) && Number.isFinite(lat);

      const payload = {
        codigo: f.codigo.value.trim(),
        nombre: f.nombre.value.trim(),
        parroquia: (f.parroquia.value || "").trim(),
        comunidad: (f.comunidad.value || "").trim(),
        ubicacion: {
          type: "Point",
          coordinates: coordsOK ? [lng, lat] : [-79.84, 0.87]
        },
        estado: f.estado.value,
        directiva: {
          presidente: {
            nombres: (f.pres_nombres.value || "").trim(),
            telefono: (f.pres_telefono.value || "").trim(),
            email: (f.pres_email.value || "").trim()
          }
        }
      };

      try {
        let res;

        if (modo === "create") {
          res = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
        } else {
          res = await fetch(`${API_URL}/${editId}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
        }

        if (!res.ok) {
          const err = await safeJson(res);
          const msg = err?.mensaje || err?.error || "No se pudo guardar (¿ya tienes POST/PATCH en el backend?).";
          throw new Error(msg);
        }

        bootstrap.Modal.getInstance(document.getElementById("modalForm")).hide();
        Swal.fire({ icon: "success", title: "¡Listo!", text: "Cambios guardados.", timer: 1100, showConfirmButton: false });
        await obtenerConsejos(false);
      } catch (err) {
        Swal.fire("Error", err.message || "No se pudo guardar.", "error");
      }
    });

    async function eliminarConsejo(id) {
      const c = cacheConsejos.find(x => x._id === id);
      const name = c?.codigo ? `${c.codigo} - ${c.nombre}` : "este registro";

      const conf = await Swal.fire({
        title: "¿Eliminar consejo?",
        text: `Vas a eliminar ${name}. Esta acción no se puede deshacer.`,
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        confirmButtonText: "Sí, eliminar",
        cancelButtonText: "Cancelar"
      });

      if (!conf.isConfirmed) return;

      try {
        const res = await fetch(`${API_URL}/${id}`, { method: "DELETE" });
        if (!res.ok) throw new Error("No se pudo eliminar (¿ya tienes DELETE en el backend?).");
        Swal.fire({ icon: "success", title: "Eliminado", timer: 900, showConfirmButton: false });
        await obtenerConsejos(false);
      } catch (err) {
        Swal.fire("Error", err.message || "No se pudo eliminar.", "error");
      }
    }

    async function verDetalle(id) {
      const c = cacheConsejos.find(x => x._id === id);
      if (!c) return;

      const pres = c?.directiva?.presidente || {};
      const coords = c?.ubicacion?.coordinates || [];

      const gm = coords.length ? `https://www.google.com/maps?q=${coords[1]},${coords[0]}` : null;

      document.getElementById("detalleBody").innerHTML = `
        <div class="row g-3">
          <div class="col-md-6">
            <div class="fw-bold text-primary">Información</div>
            <div><span class="muted">Código:</span> <span class="fw-bold">${escapeHtml(c.codigo || "-")}</span></div>
            <div><span class="muted">Nombre:</span> ${escapeHtml(c.nombre || "-")}</div>
            <div><span class="muted">Parroquia:</span> ${escapeHtml(c.parroquia || "-")}</div>
            <div><span class="muted">Comunidad:</span> ${escapeHtml(c.comunidad || "-")}</div>
            <div class="mt-2">${badgeEstado(c.estado)}</div>
          </div>

          <div class="col-md-6">
            <div class="fw-bold text-primary">Directiva</div>
            <div><span class="muted">Presidente:</span> ${escapeHtml(pres.nombres || "-")}</div>
            <div><span class="muted">Teléfono:</span> ${escapeHtml(pres.telefono || "-")}</div>
            <div><span class="muted">Email:</span> ${escapeHtml(pres.email || "-")}</div>
          </div>

          <div class="col-12">
            <hr>
            <div class="fw-bold text-primary">Ubicación</div>
            <div><span class="muted">Coordenadas:</span> ${coords.length ? `${coords[0]}, ${coords[1]}` : "-"}</div>
            ${gm ? `<a class="btn btn-sm btn-outline-primary rounded-pill mt-2" href="${gm}" target="_blank">
              <i class="fa-solid fa-map-location-dot me-2"></i>Ver en Google Maps
            </a>` : ""}
          </div>
        </div>
      `;

      new bootstrap.Modal(document.getElementById("modalDetalle")).show();
    }

    function debounce(fn, delay) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(null, args), delay);
      };
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function safeJson(res) {
      try { return await res.json(); } catch { return null; }
    }
  </script>
</body>
</html>


