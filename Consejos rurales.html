<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Consejos Rurales - Atacames (Consulta Pública)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

  <style>
    :root{
      --primary-color:#0097e6;
      --dark-color:#2f3640;
      --light-bg:#f8f9fc;
      --primary-gradient: linear-gradient(135deg, #0097e6 0%, #0052d4 100%);
    }

    body{
      font-family:'Poppins',sans-serif;
      background:var(--light-bg);
      color:#333;
      padding-top:80px;
    }

    .navbar{
      background:rgba(255,255,255,.98);
      box-shadow:0 2px 15px rgba(0,0,0,.08);
      padding:10px 0;
    }

    .dropdown-menu{
      border:none;
      box-shadow:0 15px 35px rgba(0,0,0,.15);
      border-radius:15px;
      padding:15px;
      min-width:320px;
    }
    .dropdown-item{
      padding:12px;
      border-radius:10px;
      transition:.3s;
      white-space:normal;
    }
    .dropdown-item:hover{
      background:#f8f9fa;
      transform:translateX(5px);
    }
    .menu-icon{
      width:40px;height:40px;
      background:#e1f5fe;
      color:#0097e6;
      border-radius:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      margin-right:15px;
      font-size:1.1rem;
      flex-shrink:0;
    }

    .btn-login{
      background:var(--primary-gradient);
      color:#fff !important;
      border-radius:50px;
      padding:8px 25px !important;
      font-weight:600;
    }

    .page-header{
      background:linear-gradient(135deg, rgba(0,151,230,.9), rgba(47,54,64,.95)),
      url('https://images.unsplash.com/photo-1517486808906-6ca8b3f04846?auto=format&fit=crop&w=1350&q=80');
      background-size:cover;
      padding:120px 0 80px;
      color:#fff;
      text-align:center;
      clip-path:ellipse(150% 100% at 50% 0%);
    }

    .main-card{
      background:#fff;
      border-radius:20px;
      box-shadow:0 15px 35px rgba(0,0,0,.05);
      margin-top:-60px;
      padding:30px;
      margin-bottom:40px;
    }

    .custom-table tbody tr:hover{
      transform:scale(1.005);
      background:#fdfdfd;
      transition:.2s;
    }

    .badge-status{ padding:6px 12px; border-radius:50px; font-weight:700; font-size:.75rem; }
    .st-ACTIVO{ background:#dff9fb; color:#0984e3; }
    .st-INACTIVO{ background:#ffeaea; color:#d63031; }
    .st-EN_PROCESO{ background:#fff7df; color:#b8860b; }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:10px;
      background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.20);
      padding:10px 14px;
      border-radius:999px;
      font-weight:600;
      margin-top:14px;
    }

    .skeleton{
      background:linear-gradient(90deg,#f0f0f0 25%,#e6e6e6 37%,#f0f0f0 63%);
      background-size:400% 100%;
      animation:shine 1.2s ease-in-out infinite;
      border-radius:10px;
      height:14px;
    }
    @keyframes shine{0%{background-position:100% 0}100%{background-position:0 0}}

    footer{ background:var(--dark-color); color:#fff; padding:40px 0; margin-top:50px; }

    /* ✅ Actividades */
    .act-card{
      background:#fff;
      border:1px solid #edf2f7;
      border-radius:14px;
      padding:14px;
      margin-bottom:10px;
    }
    .act-title{
      font-weight:800;
      color:#111827;
      margin:0 0 6px 0;
      font-size:1rem;
    }
    .act-meta{ color:#64748b; font-size:.85rem; margin:0; }

    /* ✅ Modal Detalle */
    .detail-hero{
      position:relative;
      height:170px;
      background:#e5e7eb;
      overflow:hidden;
    }
    .detail-hero img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      filter:saturate(1.05);
    }
    .detail-close{
      position:absolute;
      top:12px;
      right:12px;
      z-index:5;
      background:rgba(255,255,255,.92);
      border:1px solid rgba(15,23,42,.15);
      border-radius:999px;
      padding:6px 12px;
      font-weight:700;
      color:#334155;
    }
    .detail-avatar-wrap{
      position:relative;
      display:flex;
      justify-content:center;
      margin-top:-56px;
      z-index:6;
    }
    .detail-avatar{
      width:112px;height:112px;
      border-radius:999px;
      border:6px solid #fff;
      box-shadow:0 12px 25px rgba(0,0,0,.15);
      object-fit:cover;
      background:#fff;
    }
    .detail-head{
      text-align:center;
      padding:14px 18px 6px;
    }
    .detail-name{
      font-weight:900;
      letter-spacing:.3px;
      color:#0f172a;
      font-size:1.45rem;
      margin:0;
      text-transform:uppercase;
    }
    .detail-sub{
      margin-top:6px;
      font-weight:800;
      color:#1d4ed8;
      text-transform:uppercase;
      letter-spacing:.5px;
    }
    .detail-divider{
      border-top:1px solid #e5e7eb;
      margin:14px 0 0;
    }

    .detail-grid{
      display:grid;
      grid-template-columns: 1fr 1.35fr;
      gap:16px;
      padding:16px 18px 18px;
    }
    @media(max-width: 992px){
      .detail-grid{ grid-template-columns: 1fr; }
    }

    .panel{
      background:#fff;
      border:1px solid #e8edf5;
      border-radius:14px;
      overflow:hidden;
    }
    .panel-h{
      padding:14px 14px 10px;
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      color:#0f172a;
      font-size:1.05rem;
    }
    .panel-h i{
      color:#0b5ed7;
      font-size:1.1rem;
    }
    .panel-b{
      padding:10px 14px 14px;
    }
    .k{
      font-size:.78rem;
      color:#94a3b8;
      font-weight:800;
      text-transform:uppercase;
      margin-bottom:4px;
    }
    .v{
      font-weight:800;
      color:#0f172a;
      margin-bottom:12px;
    }

    .status-pill{
      display:inline-flex;
      align-items:center;
      padding:7px 14px;
      border-radius:999px;
      font-weight:900;
      font-size:.85rem;
      margin-top:4px;
    }
    .status-pill.ACTIVO{ background:#dff9fb; color:#0984e3; }
    .status-pill.INACTIVO{ background:#ffeaea; color:#d63031; }
    .status-pill.EN_PROCESO{ background:#fff7df; color:#b8860b; }

    .dir-card{
      background:#fff;
      border:1px solid #edf2f7;
      border-radius:14px;
      padding:14px;
      margin-bottom:12px;
      box-shadow:0 8px 20px rgba(15,23,42,.04);
      position:relative;
      overflow:hidden;
    }
    .dir-card::before{
      content:"";
      position:absolute;
      left:0; top:0;
      width:5px; height:100%;
      background:#0b5ed7;
    }
    .dir-tag{
      font-size:.72rem;
      font-weight:900;
      color:#0b5ed7;
      text-transform:uppercase;
      margin-bottom:4px;
    }
    .dir-name{
      font-weight:900;
      color:#0f172a;
      margin:0 0 6px;
      text-transform:uppercase;
    }
    .dir-line{
      display:flex;
      align-items:center;
      gap:8px;
      color:#334155;
      font-weight:700;
    }
    .dir-line i{ color:#16a34a; }

    .gallery{
      margin-top:10px;
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:10px;
    }
    @media(max-width: 768px){
      .gallery{ grid-template-columns:repeat(2, 1fr); }
    }
    .g-item{
      border-radius:14px;
      overflow:hidden;
      border:1px solid #edf2f7;
      background:#fff;
    }
    .g-item img{
      width:100%;
      height:120px;
      object-fit:cover;
      display:block;
    }
    .g-cap{
      padding:8px 10px;
      font-size:.85rem;
      color:#334155;
      font-weight:700;
    }

    .btn-map{
      border-radius:999px;
      font-weight:900;
    }

    /* Admin modal */
    .admin-modal-bg{
      background:#0b0b0b;
      color:#fff;
      border:1px solid rgba(255,90,0,.35);
      box-shadow:0 20px 70px rgba(0,0,0,.45);
    }
    .admin-title{ letter-spacing:2px; }
    .admin-hr{ border-color:rgba(255,255,255,.15); }
    .admin-btn{ background:#ff3b30; color:#fff; }
    .admin-input{
      background:#151515;
      border:1px solid rgba(255,255,255,.15);
      color:#fff;
    }
    .admin-input::placeholder{ color:rgba(255,255,255,.35); }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg fixed-top">
    <div class="container">
      <a class="navbar-brand logo" href="Index.html">
        <img src="https://fidelpperez2021.github.io/Almacenamiento.io/Captura%20de%20pantalla%202026-01-03%20132017.png" alt="Logo" height="100" />
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto align-items-lg-center">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle fw-bold" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Participación
            </a>
            <ul class="dropdown-menu animate__animated animate__fadeIn">
              <li>
                <a class="dropdown-item d-flex align-items-center" href="Asamblea-cantonal.html">
                  <div class="menu-icon"><i class="fa-solid fa-people-group"></i></div>
                  <div>
                    <span class="d-block fw-bold">Asamblea Cantonal</span>
                    <small class="text-muted">Espacio máximo de concertación.</small>
                  </div>
                </a>
              </li>
              <li>
                <a class="dropdown-item d-flex align-items-center" href="Consejos barriales.html">
                  <div class="menu-icon"><i class="fa-solid fa-city"></i></div>
                  <div>
                    <span class="d-block fw-bold">Consejos Barriales</span>
                    <small class="text-muted">Gestión en zonas urbanas.</small>
                  </div>
                </a>
              </li>
              <li>
                <a class="dropdown-item d-flex align-items-center" href="Silla-vacia.html">
                  <div class="menu-icon"><i class="fa-solid fa-chair"></i></div>
                  <div>
                    <span class="d-block fw-bold">Silla vacía</span>
                    <small class="text-muted">Tu derecho constitucional a participar.</small>
                  </div>
                </a>
              </li>
              <li>
                <a class="dropdown-item d-flex align-items-center" href="Consejos rurales.html">
                  <div class="menu-icon"><i class="fa-solid fa-people-roof"></i></div>
                  <div>
                    <span class="d-block fw-bold">Consejos Rurales</span>
                    <small class="text-muted">Líderes de recintos y sectores.</small>
                  </div>
                </a>
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <a class="dropdown-item d-flex align-items-center" href="Actividades.html">
                  <div class="menu-icon"><i class="fa-solid fa-calendar-days"></i></div>
                  <div>
                    <span class="d-block fw-bold">Actividades</span>
                    <small class="text-muted">Cronograma de eventos.</small>
                  </div>
                </a>
              </li>
              <li>
                <a class="dropdown-item d-flex align-items-center" href="Noticias.html">
                  <div class="menu-icon"><i class="fa-solid fa-newspaper"></i></div>
                  <div>
                    <span class="d-block fw-bold">Noticias</span>
                    <small class="text-muted">Difusión de información.</small>
                  </div>
                </a>
              </li>
            </ul>
          </li>

          <li class="nav-item"><a class="nav-link fw-bold" href="#nosotros">Nosotros</a></li>

          <li class="nav-item">
            <a class="nav-link btn-login ms-lg-3" href="#" id="adminLink">
              <i class="fa-solid fa-shield-halved me-2"></i>Admin
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <header class="page-header">
    <div class="container animate__animated animate__fadeIn">
      <h1 class="fw-bold display-4">Consejos Rurales</h1>
      <p class="lead">Transparencia y participación en cada rincón de Atacames.</p>
      <div class="chip">
        <i class="fa-solid fa-eye"></i>
        <span>Consulta pública | API: <b id="apiStatus">Conectando...</b></span>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="main-card animate__animated animate__fadeInUp">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold m-0">
          <i class="fa-solid fa-list-check me-2 text-primary"></i>Directorio
        </h4>

        <button class="btn btn-outline-primary rounded-pill px-4 fw-bold" onclick="obtenerConsejos(true)">
          <i class="fa-solid fa-rotate me-2"></i>Actualizar
        </button>
      </div>

      <div class="table-responsive">
        <table class="table custom-table align-middle">
          <thead class="table-light">
            <tr>
              <th>Código</th>
              <th>Consejo</th>
              <th>Parroquia</th>
              <th>Comunidad</th>
              <th>Presidente</th>
              <th>Contacto</th>
              <th>Estado</th>
              <th class="text-center">Detalle</th>
            </tr>
          </thead>
          <tbody id="listaConsejos"></tbody>
        </table>
      </div>

      <div id="emptyState" class="text-center py-4 d-none">
        <i class="fa-regular fa-folder-open fa-2x mb-2"></i>
        <div class="fw-bold">No hay registros para mostrar</div>
        <small class="text-muted">Aún no existen consejos rurales registrados.</small>
      </div>
    </div>
  </main>

  <!-- ✅ MODAL DETALLE -->
  <div class="modal fade" id="modalDetalle" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content rounded-4 shadow border-0 overflow-hidden">
        <div id="detalleWrap"></div>
      </div>
    </div>
  </div>

  <!-- ✅ MODAL ACTIVIDADES -->
  <div class="modal fade" id="modalActividades" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content rounded-4 shadow border-0 overflow-hidden">
        <div class="modal-body p-4">
          <div class="d-flex align-items-start justify-content-between gap-3">
            <div>
              <h4 class="mb-1" style="font-weight:800; color:#111827;">Actividades del Consejo Rural</h4>
              <p class="mb-0 text-muted" id="actSubtitulo">-</p>
            </div>

            <button class="btn btn-sm btn-outline-secondary rounded-pill px-3" data-bs-dismiss="modal">
              <i class="fa-solid fa-xmark me-1"></i> Cerrar
            </button>
          </div>

          <hr class="my-3" />
          <div id="actContenido" style="max-height:420px; overflow:auto;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ MODAL ACCESO ADMIN -->
  <div class="modal fade" id="modalAdminAccess" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 admin-modal-bg">
        <div class="modal-body p-4 p-md-5">
          <div class="text-center mb-3">
            <div style="font-size:52px; color:#ff3b30;">
              <i class="fa-solid fa-triangle-exclamation"></i>
            </div>
            <h4 class="fw-bold mt-2 admin-title">ACCESO RESTRINGIDO</h4>
            <hr class="admin-hr" />
          </div>

          <p class="text-center mb-4" style="color:rgba(255,255,255,.75)">
            Usted está ingresando al <b>Modo Administrador</b>. Ingrese la clave para continuar.
          </p>

          <div class="mb-3">
            <label class="form-label" style="color:rgba(255,255,255,.75)">Clave de acceso</label>
            <input type="password" class="form-control form-control-lg rounded-3 admin-input" id="adminPass" placeholder="Ingrese la clave (Ej: Admin2024)" />
            <div class="small mt-2 d-none" id="adminError" style="color:#ff3b30;">Clave incorrecta. Intente nuevamente.</div>
          </div>

          <button class="btn w-100 fw-bold py-3 rounded-3 admin-btn" id="btnAdminEnter">
            ACEPTAR LA RESPONSABILIDAD Y ENTRAR
          </button>

          <div class="text-center mt-3 small" style="color:rgba(255,255,255,.45)">LOG_ID: IP_ADMIN_GATEWAY</div>
        </div>
      </div>
    </div>
  </div>

  <footer class="text-center">
    <div class="container">
      <p class="m-0">&copy; 2026 Asamblea Cantonal de Atacames. Gobierno Autónomo Descentralizado.</p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API_URL = "https://backend-asamblea-atacames.onrender.com/api/consejos-rurales";
    let cacheConsejos = [];

    document.addEventListener("DOMContentLoaded", () => obtenerConsejos(false));

    async function pingApi(){
      try{
        const r = await fetch(API_URL, { method:"GET" });
        document.getElementById("apiStatus").textContent = r.ok ? "Online" : "Error";
      }catch{
        document.getElementById("apiStatus").textContent = "Offline";
      }
    }

    async function obtenerConsejos(showToast=false){
      await pingApi();
      renderLoading();

      try{
        const res = await fetch(API_URL);
        if(!res.ok) throw new Error("No se pudo obtener datos");
        const datos = await res.json();
        cacheConsejos = Array.isArray(datos) ? datos : (datos.data || []);
        renderTable(cacheConsejos);
        if(showToast) console.log("Actualizado");
      }catch(err){
        console.error(err);
        renderEmpty(true);
      }
    }

    function badgeEstado(estado){
      const st = (estado || "ACTIVO").toString().trim();
      return `<span class="badge-status st-${st}">${escapeHtml(st)}</span>`;
    }

    function renderLoading(){
      const tbody = document.getElementById("listaConsejos");
      document.getElementById("emptyState").classList.add("d-none");
      tbody.innerHTML = `
        <tr><td colspan="8">
          <div class="p-3">
            <div class="skeleton mb-2" style="width:45%"></div>
            <div class="skeleton mb-2" style="width:70%"></div>
            <div class="skeleton" style="width:55%"></div>
          </div>
        </td></tr>
      `;
    }

    function renderEmpty(show=false){
      document.getElementById("listaConsejos").innerHTML = "";
      document.getElementById("emptyState").classList.toggle("d-none", !show);
    }

    function renderTable(list){
      const tbody = document.getElementById("listaConsejos");
      tbody.innerHTML = "";

      if(!list.length){
        renderEmpty(true);
        return;
      }
      renderEmpty(false);

      list.forEach(c => {
        const pres = c?.directiva?.presidente?.nombres || "No asignado";
        const tel = c?.directiva?.presidente?.telefono || "-";

        tbody.innerHTML += `
          <tr>
            <td><span class="badge bg-light text-dark border">${escapeHtml(c.codigo || "-")}</span></td>
            <td><div class="fw-bold">${escapeHtml(c.nombre || "-")}</div></td>
            <td>${escapeHtml(c.parroquia || "-")}</td>
            <td>${escapeHtml(c.comunidad || "-")}</td>
            <td>${escapeHtml(pres)}</td>
            <td><i class="fa-solid fa-phone me-1 text-success"></i>${escapeHtml(tel)}</td>
            <td>${badgeEstado(c.estado)}</td>
            <td class="text-center">
              <div class="d-flex gap-2 justify-content-center flex-wrap">
                <button class="btn btn-sm btn-outline-dark border-0" onclick="verDetalle('${c._id}')" title="Ver detalle">
                  <i class="fa-regular fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-primary border-0" onclick="verActividades('${c._id}')" title="Actividades">
                  <i class="fa-solid fa-calendar-check"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      });
    }

    // ✅ Actividades
    function getActividadesFromConsejo(c){
      if (!Array.isArray(c?.actividades)) return [];
      return c.actividades;
    }

    function fmtFecha(fechaISO){
      if(!fechaISO) return "";
      try{
        const d = new Date(fechaISO);
        return d.toLocaleDateString("es-EC", { year:"numeric", month:"long", day:"numeric" });
      }catch{
        return fechaISO;
      }
    }

    function verActividades(id){
      const c = cacheConsejos.find(x => x._id === id);
      if(!c) return;

      document.getElementById("actSubtitulo").innerText =
        `${c.nombre || "-"} • ${c.comunidad || "-"} • Código: ${c.codigo || "-"}`;

      const actividades = getActividadesFromConsejo(c);
      const cont = document.getElementById("actContenido");

      if(!actividades.length){
        cont.innerHTML = `
          <div class="text-center text-muted py-4">
            <i class="fa-solid fa-circle-info me-2"></i>
            No hay actividades registradas para este consejo rural.
          </div>
        `;
      }else{
        cont.innerHTML = actividades.map((a) => {
          const titulo = (a?.titulo || "Actividad").toString();
          const desc = (a?.descripcion || "").toString().trim();
          const fecha = fmtFecha(a?.fecha);
          const lugar = (a?.lugar || "").toString().trim();
          const estado = (a?.estado || "").toString().trim();

          const imgs = Array.isArray(a?.imagenes) ? a.imagenes : [];
          const galeria = imgs.length
            ? `
              <div class="row g-2 mt-2">
                ${imgs.slice(0, 20).map(img => `
                  <div class="col-6 col-md-4">
                    <a href="${img.url}" target="_blank" rel="noopener">
                      <img src="${img.url}" class="w-100 rounded-3" style="height:120px; object-fit:cover;"
                           alt="${escapeHtml(img.titulo || "Imagen")}">
                    </a>
                    ${img.titulo ? `<div class="small text-muted mt-1">${escapeHtml(img.titulo)}</div>` : ""}
                  </div>
                `).join("")}
              </div>
            `
            : "";

          return `
            <div class="act-card">
              <p class="act-title mb-1">
                <i class="fa-solid fa-calendar-check me-2 text-primary"></i>
                ${escapeHtml(titulo)}
              </p>

              ${(estado || fecha || lugar) ? `
                <p class="act-meta mb-1">
                  ${estado ? `<b>${escapeHtml(estado)}</b>` : ""}
                  ${(estado && (fecha || lugar)) ? ` • ` : ""}
                  ${fecha ? `<i class="fa-regular fa-calendar me-1"></i>${escapeHtml(fecha)}` : ""}
                  ${(fecha && lugar) ? ` • ` : ""}
                  ${lugar ? `<i class="fa-solid fa-location-dot me-1"></i>${escapeHtml(lugar)}` : ""}
                </p>
              ` : ""}

              ${desc ? `<div class="small text-muted">${escapeHtml(desc)}</div>` : ""}
              ${galeria}
            </div>
          `;
        }).join("");
      }

      new bootstrap.Modal(document.getElementById("modalActividades")).show();
    }

    /* =========================
      ✅ DETALLE + LISTAR TODA LA DIRECTIVA
    ========================== */

    function getEstadoPill(estado){
      const st = (estado || "ACTIVO").toString().trim();
      return `<span class="status-pill ${escapeHtml(st)}">${escapeHtml(st)}</span>`;
    }

    function firstNonEmpty(...vals){
      for (const v of vals){
        if (typeof v === "string" && v.trim()) return v.trim();
      }
      return "";
    }

    function getConsejoGaleria(c){
      const a = Array.isArray(c?.imagenes) ? c.imagenes : [];
      const b = Array.isArray(c?.galeria) ? c.galeria : [];
      return [...a, ...b].filter(x => x && x.url);
    }

    function ensurePersona(p){
      return (p && typeof p === "object") ? p : {};
    }

    function buildDirCard(tag, persona){
      const p = ensurePersona(persona);
      const nombre = firstNonEmpty(p?.nombres, p?.nombre, "PENDIENTE");
      const tel = firstNonEmpty(p?.telefono, "-");
      const email = firstNonEmpty(p?.email, "");

      return `
        <div class="dir-card">
          <div class="dir-tag">${escapeHtml(tag)}</div>
          <div class="dir-name">${escapeHtml(nombre)}</div>

          ${tel && tel !== "-" ? `
            <div class="dir-line">
              <i class="fa-solid fa-phone"></i> ${escapeHtml(tel)}
            </div>
          ` : `
            <div class="dir-line" style="color:#64748b;">
              <i class="fa-solid fa-phone" style="color:#94a3b8;"></i> ...
            </div>
          `}

          ${email ? `
            <div class="dir-line mt-1" style="color:#334155;">
              <i class="fa-solid fa-envelope" style="color:#0b5ed7;"></i> ${escapeHtml(email)}
            </div>
          ` : ""}
        </div>
      `;
    }

    function verDetalle(id){
      const c = cacheConsejos.find(x => x._id === id);
      if(!c) return;

      const dir = c?.directiva || {};
      const pres = ensurePersona(dir?.presidente);
      const vice = ensurePersona(dir?.vicepresidente);
      const sec  = ensurePersona(dir?.secretario);
      const tes  = ensurePersona(dir?.tesorero);

      const coords = c?.ubicacion?.coordinates || [];
      const gm = coords.length ? `https://www.google.com/maps?q=${coords[1]},${coords[0]}` : null;

      // ✅ Portada/Perfil desde BD (del presidente)
      const portada = firstNonEmpty(
        pres?.Portada,
        "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1600&q=80"
      );

      const avatar = firstNonEmpty(
        pres?.Perfil,
        "https://ui-avatars.com/api/?name=Consejo+Rural&background=0D8ABC&color=fff&size=256"
      );

      const rol = "PRESIDENTE/A";
      const nombrePres = firstNonEmpty(pres?.nombres, "PENDIENTE");
      const consejoLabel = `CONSEJO RURAL: ${firstNonEmpty(c?.nombre, "-")}`;

      const referencia = firstNonEmpty(c?.referencia, c?.direccion, c?.detalle, "");
      const parroquia = firstNonEmpty(c?.parroquia, "-");
      const comunidad = firstNonEmpty(c?.comunidad, "-");
      const codigo = firstNonEmpty(c?.codigo, "-");
      const estado = firstNonEmpty(c?.estado, "ACTIVO");

      const gal = getConsejoGaleria(c);
      const galHtml = gal.length ? `
        <div class="panel mt-3">
          <div class="panel-h"><i class="fa-regular fa-images"></i> Imágenes</div>
          <div class="panel-b">
            <div class="gallery">
              ${gal.slice(0, 18).map(img => `
                <div class="g-item">
                  <a href="${img.url}" target="_blank" rel="noopener">
                    <img src="${img.url}" alt="${escapeHtml(img.titulo || "Imagen")}">
                  </a>
                  ${img.titulo ? `<div class="g-cap">${escapeHtml(img.titulo)}</div>` : ""}
                </div>
              `).join("")}
            </div>
          </div>
        </div>
      ` : "";

      document.getElementById("detalleWrap").innerHTML = `
        <div class="detail-hero">
          <img src="${escapeHtml(portada)}" alt="Portada"
               onerror="this.onerror=null;this.src='https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1600&q=80';">
          <button class="detail-close" data-bs-dismiss="modal">
            <i class="fa-solid fa-xmark me-1"></i> Cerrar
          </button>
        </div>

        <div class="detail-avatar-wrap">
          <img class="detail-avatar" src="${escapeHtml(avatar)}" alt="Perfil"
               onerror="this.onerror=null;this.src='https://ui-avatars.com/api/?name=Consejo+Rural&background=0D8ABC&color=fff&size=256';">
        </div>

        <div class="detail-head">
          <p class="detail-name">${escapeHtml(nombrePres)} &nbsp;–&nbsp; ${escapeHtml(rol)}</p>
          <div class="detail-sub">${escapeHtml(consejoLabel)}</div>
          <div class="text-muted mt-2" style="font-weight:700;">
            ${escapeHtml(firstNonEmpty(c?.nombre, "-"))} • ${escapeHtml(comunidad)} • Código: ${escapeHtml(codigo)}
          </div>
        </div>

        <div class="detail-divider"></div>

        <div class="detail-grid">

          <div>
            <div class="panel">
              <div class="panel-h"><i class="fa-solid fa-map-pin"></i> Sector</div>
              <div class="panel-b">
                <div class="k">Comunidad / Sector</div>
                <div class="v">${escapeHtml(comunidad)}</div>

                <div class="k">Parroquia</div>
                <div class="v">${escapeHtml(parroquia)}</div>

                <div class="k">Estado</div>
                <div class="v">${getEstadoPill(estado)}</div>

                ${referencia ? `
                  <div class="k mt-2">Referencia</div>
                  <div class="v" style="font-weight:700; color:#334155;">
                    ${escapeHtml(referencia)}
                  </div>
                ` : ""}
              </div>
            </div>

            <div class="panel mt-3">
              <div class="panel-h"><i class="fa-solid fa-location-dot"></i> Ubicación</div>
              <div class="panel-b">
                <div class="k">Coordenadas</div>
                <div class="v" style="font-family:ui-monospace,monospace;">
                  ${coords.length ? `${escapeHtml(coords[0])}, ${escapeHtml(coords[1])}` : "-"}
                </div>

                ${gm ? `
                  <a class="btn btn-outline-primary btn-map mt-2" href="${gm}" target="_blank" rel="noopener">
                    <i class="fa-solid fa-map-location-dot me-2"></i> Ver en Google Maps
                  </a>
                ` : ""}
              </div>
            </div>

            ${galHtml}
          </div>

          <div>
            <div class="panel">
              <div class="panel-h"><i class="fa-solid fa-users"></i> Directiva Completa</div>
              <div class="panel-b">
                ${buildDirCard("PRESIDENTE/A", pres)}
                ${buildDirCard("VICEPRESIDENTE/A", vice)}
                ${buildDirCard("SECRETARIO/A", sec)}
                ${buildDirCard("TESORERO/A", tes)}
              </div>
            </div>
          </div>

        </div>
      `;

      new bootstrap.Modal(document.getElementById("modalDetalle")).show();
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
  </script>

  <script>
    const ADMIN_URL = "https://fidelpperez2021.github.io/Almacenamiento.io/Consejos-rurales-admin.html";
    const ADMIN_KEY = "Admin2025";

    const adminLink = document.getElementById("adminLink");

    adminLink?.addEventListener("click", (e) => {
      e.preventDefault();

      const pass = document.getElementById("adminPass");
      const err = document.getElementById("adminError");

      if(pass) pass.value = "";
      if(err) err.classList.add("d-none");

      const modal = new bootstrap.Modal(document.getElementById("modalAdminAccess"));
      modal.show();

      setTimeout(() => pass?.focus(), 350);
    });

    document.getElementById("btnAdminEnter")?.addEventListener("click", () => {
      const pass = document.getElementById("adminPass");
      const err = document.getElementById("adminError");
      const value = (pass?.value || "").trim();

      if(value !== ADMIN_KEY){
        err?.classList.remove("d-none");
        pass?.focus();
        return;
      }

      sessionStorage.setItem("admin_access_ok", "1");
      window.location.href = ADMIN_URL;
    });

    document.getElementById("adminPass")?.addEventListener("keydown", (e) => {
      if(e.key === "Enter") document.getElementById("btnAdminEnter")?.click();
    });
  </script>
</body>
</html>

