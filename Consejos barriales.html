<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Consejos Barriales - Atacames</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet" />

  <style>
    :root{
      --primary:#007bff;
      --bg:#f8f9fc;
      --dark-footer:#2d3748;
    }
    body{
      font-family:'Plus Jakarta Sans',sans-serif;
      background:var(--bg);
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    .navbar{
      background:white;
      padding:10px 0;
      border-bottom:1px solid #edf2f7;
    }
    .navbar-brand img{ height:95px; width:auto; }

    .nav-link{
      font-weight:700;
      color:#4a5568 !important;
      font-size:.9rem;
      margin-left:20px;
    }
    .nav-link i{ color:var(--primary); margin-right:5px; }

    .hero-banner{
      background:linear-gradient(90deg,#0091ff 0%,#1a202c 100%);
      padding:60px 0;
      color:white;
      text-align:center;
    }

    .main-content{ flex:1; padding:50px 0; }

    /* ✅ BANNER NATURAL */
    .modal-profile-header{
      height:190px;
      position:relative;
      background-color:#000; /* fallback */
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
    }

    .profile-img-wrapper{
      position:absolute;
      top:95px;
      left:50%;
      transform:translateX(-50%);
      z-index:10;
    }

    .profile-main-img,.profile-initials{
      width:150px; height:150px;
      border-radius:50%;
      border:6px solid #fff;
      object-fit:cover;
      background:#0091ff;
      display:flex; align-items:center; justify-content:center;
      color:white; font-size:3.5rem; font-weight:700;
      box-shadow:0 4px 15px rgba(0,0,0,.15);
    }

    .profile-title-section{
      margin-top:85px;
      text-align:center;
      margin-bottom:20px;
      padding:0 15px;
    }

    /* ✅ Presidente arriba */
    .profile-president-line{
      display:flex;
      justify-content:center;
      align-items:baseline;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:6px;
    }

    .profile-president-name{
      font-size:1.35rem;
      font-weight:800;
      color:#111827;
      margin:0;
    }

    .pres-tag{
      background:transparent;
      color:#111827;
      padding:0;
      border-radius:0;

      font-size:1.35rem;
      font-weight:800;

      text-transform:uppercase;
      letter-spacing:.5px;

      margin:0;
      line-height:1;
    }

    .pres-sep{
      font-size:1.35rem;
      font-weight:800;
      color:#111827;
      line-height:1;
    }

    .profile-council-name{
      font-size:1.05rem;
      font-weight:700;
      color:var(--primary);
      text-transform:uppercase;
      letter-spacing:1px;
      margin:0;
    }

    .top-officials-grid{
      display:flex;
      justify-content:center;
      gap:15px;
      flex-wrap:wrap;
      margin-top:15px;
      padding-top:15px;
      border-top:1px solid #eee;
    }
    .top-official-item{ text-align:center; min-width:130px; padding:5px; }
    .top-official-name{ font-size:.85rem; font-weight:700; color:#1a202c; display:block; }
    .top-official-label{ font-size:.6rem; font-weight:800; color:#94a3b8; text-transform:uppercase; }

    .info-header{
      font-weight:800; font-size:1.1rem; color:#333;
      margin-bottom:20px; display:flex; align-items:center; gap:10px;
      border-bottom:2px solid #eee; padding-bottom:5px;
    }
    .data-label{ font-size:.7rem; text-transform:uppercase; font-weight:800; color:#94a3b8; margin-bottom:2px; }
    .data-value{ font-size:.95rem; font-weight:600; color:#334155; margin-bottom:15px; }

    .directory-item{
      margin-bottom:10px; padding:12px; border-radius:12px; background:#fff;
      border:1px solid #edf2f7; border-left:4px solid var(--primary);
    }
    .role-tag{ font-size:.65rem; text-transform:uppercase; font-weight:800; color:var(--primary); display:block; }
    .member-name{ font-size:.9rem; font-weight:700; color:#1a202c; }

    .st-ACTIVO{
      background:#ecfdf5; color:#10b981;
      padding:4px 12px; border-radius:50px;
      font-weight:800; font-size:.7rem;
    }

    footer{ background:var(--dark-footer); color:#cbd5e0; padding:30px 0; text-align:center; }
    .btn-close-dark{
      background:#1e293b; color:white; border-radius:50px;
      padding:10px 50px; font-weight:800; border:none;
    }

    /* ✅ Actividades */
    .act-card{
      background:#fff;
      border:1px solid #edf2f7;
      border-radius:14px;
      padding:14px;
      margin-bottom:10px;
    }
    .act-title{
      font-weight:800;
      color:#111827;
      margin:0 0 6px 0;
      font-size:1rem;
    }
    .act-meta{
      color:#64748b;
      font-size:.85rem;
      margin:0;
    }
  </style>
</head>

<body>

  <nav class="navbar navbar-expand-lg shadow-sm sticky-top">
    <div class="container">
      <a class="navbar-brand" href="#">
        <img src="https://fidelpperez2021.github.io/Almacenamiento.io/Captura%20de%20pantalla%202026-01-03%20132017.png" alt="GAD Atacames">
      </a>
      <div class="ms-auto d-flex">
        <a class="nav-link" href="Index.html"><i class="fa-solid fa-house"></i> Inicio</a>
        <a class="nav-link admin-link" href="https://fidelpperez2021.github.io/Almacenamiento.io/Consejos%20barriales%20Admin.html"><i class="fa-solid fa-shield-halved"></i> Admin</a>
      </div>
    </div>
  </nav>

  <header class="hero-banner">
    <div class="container">
      <h1>Consejos Barriales</h1>
      <p class="opacity-75">Consulta pública de directivas del Cantón Atacames</p>
    </div>
  </header>

  <main class="main-content">
    <div class="container">
      <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <table class="table align-middle mb-0 table-hover">
          <thead class="bg-light">
            <tr>
              <th class="px-4">Código</th>
              <th>Consejo Barrial</th>
              <th class="text-center">Acción</th>
            </tr>
          </thead>
          <tbody id="listaConsejos"></tbody>
        </table>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <p class="mb-0">© 2026 Asamblea Cantonal de Participación Ciudadana de Atacames.</p>
    </div>
  </footer>

  <!-- MODAL PERFIL -->
  <div class="modal fade" id="modalDetalle" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content border-0 rounded-4 overflow-hidden shadow">
        <div class="modal-body p-0">
          <div class="modal-profile-header" id="modalHeader">
            <div class="profile-img-wrapper" id="contFotoPres"></div>
          </div>

          <div class="profile-title-section">
            <div class="profile-president-line">
              <p class="profile-president-name" id="detPresNombre">-</p>
              <span class="pres-sep">-</span>
              <span class="pres-tag">Presidente/a</span>
            </div>

            <p class="profile-council-name" id="detConsejoNombre">Consejo Barrial</p>

            <div id="topOfficials" class="top-officials-grid"></div>
          </div>

          <div class="container px-lg-5 pb-4">
            <div class="row">
              <div class="col-md-5 border-end">
                <div class="info-header"><i class="fa-solid fa-map-marked-alt text-primary"></i> Sector</div>
                <div class="data-label">Barrio / Sector</div>
                <div class="data-value" id="detBarrio">-</div>
                <div class="data-label">Parroquia</div>
                <div class="data-value" id="detParroquia">-</div>
                <div class="data-label">Estado</div>
                <div id="detEstado" class="mb-3"></div>
                <div class="data-label">Referencia</div>
                <div class="data-value small text-muted" id="detReferencia">-</div>
              </div>

              <div class="col-md-7 ps-md-4">
                <div class="info-header"><i class="fa-solid fa-users text-primary"></i> Directorio Completo</div>
                <div id="contDirectorio" style="max-height: 400px; overflow-y: auto;"></div>
              </div>
            </div>

            <div class="text-center mt-4">
              <button class="btn btn-close-dark" data-bs-dismiss="modal">Cerrar Detalle</button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- ✅ MODAL ACTIVIDADES -->
  <div class="modal fade" id="modalActividades" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content border-0 rounded-4 overflow-hidden shadow">
        <div class="modal-body p-4">
          <div class="d-flex align-items-start justify-content-between gap-3">
            <div>
              <h4 class="fw-black mb-1" style="font-weight:800; color:#111827;">
                Actividades del Barrio
              </h4>
              <p class="mb-0 text-muted" id="actSubtitulo">-</p>
            </div>
            <button class="btn btn-sm btn-outline-secondary rounded-pill px-3" data-bs-dismiss="modal">
              <i class="fa-solid fa-xmark me-1"></i> Cerrar
            </button>
          </div>

          <hr class="my-3">

          <div id="actContenido" style="max-height:420px; overflow:auto;"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API_URL = "https://backend-asamblea-atacames.onrender.com/api/consejos-barriales";
    let cacheConsejos = [];

    const getNombre = (o) => (o?.nombres || o?.nombre || o?.name || "").toString().trim();
    const getTel = (o) => (o?.telefono || o?.teléfono || o?.phone || "").toString().trim();

    const getUrl = (o, keys=[]) => {
      if(!o) return "";
      for (const k of keys) {
        const v = o?.[k];
        if (typeof v === "string" && v.trim()) return v.trim();
      }
      return "";
    };

    // ✅ SOLO actividades reales del backend: actividades[]
    function getActividadesFromConsejo(c){
      if (!Array.isArray(c?.actividades)) return [];
      return c.actividades;
    }

    function fmtFecha(fechaISO){
      if(!fechaISO) return "";
      try{
        const d = new Date(fechaISO);
        return d.toLocaleDateString("es-EC", { year:"numeric", month:"long", day:"numeric" });
      }catch(e){
        return fechaISO;
      }
    }

    async function cargarDatos() {
      try {
        const res = await fetch(API_URL);
        cacheConsejos = await res.json();
        renderizarTabla();
      } catch (e) {
        console.error("Error API", e);
      }
    }

    function renderizarTabla() {
      const tbody = document.getElementById("listaConsejos");

      tbody.innerHTML = cacheConsejos.map(c => {
        return `
          <tr>
            <td class="px-4"><code>${c.codigo}</code></td>
            <td class="fw-bold">${c.nombre}</td>
            <td class="text-center">
              <div class="d-flex gap-2 justify-content-center flex-wrap">
                <button class="btn btn-sm btn-primary rounded-pill px-3 fw-bold"
                  onclick="verDetalle('${c._id}')">
                  Ver Perfil
                </button>

                <button class="btn btn-sm btn-outline-primary rounded-pill px-3 fw-bold"
                  onclick="verActividades('${c._id}')">
                  <i class="fa-solid fa-calendar-check me-1"></i> Actividades
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join("");
    }

    function verActividades(id){
      const c = cacheConsejos.find(x => x._id === id);
      if (!c) return;

      document.getElementById("actSubtitulo").innerText =
        `Consejo Barrial: ${c.nombre || "-"}  •  Código: ${c.codigo || "-"}`;

      const actividades = getActividadesFromConsejo(c);
      const cont = document.getElementById("actContenido");

      if (!actividades || actividades.length === 0){
        cont.innerHTML = `
          <div class="text-center text-muted py-4">
            <i class="fa-solid fa-circle-info me-2"></i>
            No hay actividades registradas para este barrio.
          </div>
        `;
      } else {
        cont.innerHTML = actividades.map((a) => {
          const titulo = (a?.titulo || "Actividad").toString();
          const desc = (a?.descripcion || "").toString().trim();
          const fecha = fmtFecha(a?.fecha);
          const lugar = (a?.lugar || "").toString().trim();
          const estado = (a?.estado || "").toString().trim();

          const imgs = Array.isArray(a?.imagenes) ? a.imagenes : [];
          const galeria = imgs.length
            ? `
              <div class="row g-2 mt-2">
                ${imgs.slice(0, 20).map(img => `
                  <div class="col-6 col-md-4">
                    <a href="${img.url}" target="_blank" rel="noopener">
                      <img src="${img.url}" class="w-100 rounded-3" style="height:120px; object-fit:cover;" alt="${img.titulo || "Imagen"}">
                    </a>
                    ${img.titulo ? `<div class="small text-muted mt-1">${img.titulo}</div>` : ""}
                  </div>
                `).join("")}
              </div>
            `
            : "";

          return `
            <div class="act-card">
              <p class="act-title mb-1">
                <i class="fa-solid fa-calendar-check me-2 text-primary"></i>
                ${titulo}
              </p>

              ${(estado || fecha || lugar) ? `
                <p class="act-meta mb-1">
                  ${estado ? `<b>${estado}</b>` : ""}
                  ${(estado && (fecha || lugar)) ? ` • ` : ""}
                  ${fecha ? `<i class="fa-regular fa-calendar me-1"></i>${fecha}` : ""}
                  ${(fecha && lugar) ? ` • ` : ""}
                  ${lugar ? `<i class="fa-solid fa-location-dot me-1"></i>${lugar}` : ""}
                </p>
              ` : ""}

              ${desc ? `<div class="small text-muted">${desc}</div>` : ""}

              ${galeria}
            </div>
          `;
        }).join("");
      }

      new bootstrap.Modal(document.getElementById("modalActividades")).show();
    }

    function verDetalle(id) {
      const c = cacheConsejos.find(x => x._id === id);
      if (!c) return;

      const dir = c.directiva?.objetivo || c.directiva || {};
      const pres = dir.presidente || {};

      const vice = dir.Vicepresidente || dir.vicepresidente || dir["Vicepresidente:"] || {};
      const sec  = dir.Secretario || dir.secretario || {};
      const tes  = dir.Tesorero || dir.tesorero || {};

      const bannerUrl = getUrl(pres, ["Perfil", "perfil", "foto"]);
      const circleUrl = getUrl(pres, ["Portada", "portada", "foto", "Perfil", "perfil"]);

      const header = document.getElementById("modalHeader");
      if (bannerUrl) {
        header.style.backgroundImage = `url('${bannerUrl}')`;
      } else {
        header.style.backgroundImage = "none";
        header.style.backgroundColor = "#000";
      }

      const contFoto = document.getElementById("contFotoPres");
      if (circleUrl) {
        contFoto.innerHTML = `<img src="${circleUrl}" class="profile-main-img" alt="Foto">`;
      } else {
        const n = getNombre(pres) || "CB";
        const iniciales = n.split(" ").filter(Boolean).map(w => w[0]).join("").substring(0,2).toUpperCase();
        contFoto.innerHTML = `<div class="profile-initials">${iniciales}</div>`;
      }

      document.getElementById("detPresNombre").innerText =
        getNombre(pres) || "Presidente no asignado";

      document.getElementById("detConsejoNombre").innerText =
        `Consejo Barrial: ${c.nombre || "-"}`;

      document.getElementById("detBarrio").innerText = c.barrioSector || "-";
      document.getElementById("detParroquia").innerText = c.parroquia || "-";
      document.getElementById("detReferencia").innerText = c.direccionReferencia || "-";
      document.getElementById("detEstado").innerHTML = `<span class="st-ACTIVO">${c.estado || "ACTIVO"}</span>`;

      const topOffBox = document.getElementById("topOfficials");
      let topHtml = "";

      if (getNombre(vice)) {
        topHtml += `
          <div class="top-official-item">
            <span class="top-official-label">Vicepresidente/a</span>
            <span class="top-official-name">${getNombre(vice)}</span>
          </div>`;
      }

      if (getNombre(sec)) {
        topHtml += `
          <div class="top-official-item">
            <span class="top-official-label">Secretario/a</span>
            <span class="top-official-name">${getNombre(sec)}</span>
          </div>`;
      }

      topOffBox.innerHTML = topHtml;

      const contDir = document.getElementById("contDirectorio");
      const mbs = [];

      const pushMiembro = (cargo, obj) => {
        const nombre = getNombre(obj);
        if (!nombre) return;
        mbs.push({ cargo, nombre, telf: getTel(obj) });
      };

      pushMiembro("Presidente/a", pres);
      pushMiembro("Vicepresidente/a", vice);
      pushMiembro("Secretario/a", sec);
      pushMiembro("Tesorero/a", tes);

      pushMiembro("Primer Vocal",  dir["1er-vocal"]);
      pushMiembro("Segundo Vocal", dir["2do-vocal"]);
      pushMiembro("Tercer Vocal",  dir["3er-vocal"]);

      if (Array.isArray(dir.vocales)) {
        dir.vocales.forEach(v => pushMiembro(v.cargo || "Vocal", v));
      }

      contDir.innerHTML = mbs.length > 0
        ? mbs.map(m => `
          <div class="directory-item shadow-sm">
            <span class="role-tag">${m.cargo}</span>
            <div class="member-name">${m.nombre}</div>
            ${m.telf ? `<div class="small text-muted mt-1"><i class="fa-solid fa-phone me-1 text-success"></i> ${m.telf}</div>` : ""}
          </div>
        `).join("")
        : `<p class="text-muted small text-center">Sin directiva registrada.</p>`;

      new bootstrap.Modal(document.getElementById("modalDetalle")).show();
    }

    window.onload = cargarDatos;
  </script>

</body>
</html>
